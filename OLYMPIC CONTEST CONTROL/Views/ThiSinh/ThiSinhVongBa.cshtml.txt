@{
    ViewBag.Title = "V√≤ng 3 - Th√≠ sinh";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    body {
        background: linear-gradient(135deg, #f8f9fa 0%, #e8f5e9 100%);
        min-height: 100vh;
        font-family: 'Roboto', sans-serif;
        margin: 0;
        padding: 0;
    }

    .contest-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 30px 20px;
    }

    .welcome-section {
        background: white;
        border-radius: 20px;
        padding: 25px 30px;
        margin-bottom: 30px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.1);
        border-left: 5px solid #4caf50;
        text-align: center;
    }

    .round-title {
        color: #2e7d32;
        font-size: 2.2rem;
        font-weight: 800;
        text-align: center;
        margin-bottom: 10px;
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .round-subtitle {
        color: #4caf50;
        font-size: 1.1rem;
        text-align: center;
        margin-bottom: 0;
        font-weight: 500;
    }

    .package-selection {
        background: white;
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.1);
        border: 3px solid transparent;
        transition: all 0.3s ease;
        margin-bottom: 30px;
        text-align: center;
    }

        .package-selection:hover {
            border-color: #4caf50;
            transform: translateY(-2px);
        }

    .package-title {
        color: #2e7d32;
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 30px;
    }

    .package-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .package-button {
        background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
        color: white;
        border: none;
        padding: 25px 20px;
        border-radius: 15px;
        font-size: 1.2rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        position: relative;
        overflow: hidden;
    }

        .package-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.4);
        }

        .package-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .package-button:hover::before {
            left: 100%;
        }

    .question-box {
        background: white;
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.1);
        border: 3px solid transparent;
        transition: all 0.3s ease;
        margin-bottom: 30px;
    }

        .question-box:hover {
            border-color: #4caf50;
            transform: translateY(-2px);
        }

    .question-header {
        background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
        color: white;
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 25px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
    }

    .question-number {
        font-size: 1.3rem;
        font-weight: 700;
        margin-bottom: 5px;
    }

    .question-content {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 30px;
        border-left: 5px solid #4caf50;
        font-size: 1.2rem;
        color: #2e7d32;
        font-weight: 600;
        line-height: 1.6;
    }

    .answer-options {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .answer-button {
        background: white;
        border: 3px solid #e8f5e9;
        color: #2e7d32;
        padding: 20px 25px;
        border-radius: 15px;
        font-size: 1.1rem;
        font-weight: 600;
        text-align: left;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
        min-height: 80px;
        display: flex;
        align-items: center;
    }

        .answer-button:hover:not(:disabled) {
            border-color: #4caf50;
            background: #e8f5e9;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.2);
        }

        .answer-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .answer-button.selected {
            border-color: #ffc107;
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            color: #856404;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 193, 7, 0.3);
        }

    .star-section {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        border: 2px solid #ffc107;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 25px;
        text-align: center;
    }

    .star-button {
        background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 50px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
    }

        .star-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 193, 7, 0.4);
        }

        .star-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

    .timer-section {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        color: white;
        padding: 20px;
        border-radius: 15px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        animation: pulse 1s infinite;
    }

    @@keyframes pulse {
        0% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.02);
        }

        100% {
            transform: scale(1);
        }
    }

    .timer-text {
        font-size: 1.3rem;
        font-weight: 700;
        margin: 0;
    }

    .status-indicator {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        text-align: center;
    }

    .status-text {
        color: #666;
        font-size: 1.1rem;
        font-weight: 500;
    }

    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #e8f5e9;
        border-radius: 50%;
        border-top-color: #4caf50;
        animation: spin 1s ease-in-out infinite;
        margin-right: 10px;
    }



    @@keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    @@media (max-width: 768px) {
        .contest-container {
            padding: 15px 10px;
        }

        .package-selection,
        .question-box {
            padding: 25px 20px;
        }

        .package-buttons {
            grid-template-columns: 1fr;
        }

        .answer-options {
            grid-template-columns: 1fr;
        }

        .question-content {
            font-size: 1.1rem;
        }

        .round-title {
            font-size: 1.8rem;
        }
    }

    .final-summary {
        min-height: 100vh;
        background: #f1f8e9;
        padding: 0px;
        animation: fadeIn 0.8s ease-in-out;
    }

        .final-summary .summary-wrapper {
            background: white;
            border-radius: 0px;
            padding: 30px;
            box-shadow: none;
            width: 100%; /* chi·∫øm to√†n m√†n h√¨nh */
            max-width: 100%; /* b·ªè gi·ªõi h·∫°n */
            text-align: center;
            margin: 0; /* kh√¥ng cƒÉn gi·ªØa n·ªØa */
            text-align: center;
        }

        .final-summary h2 {
            text-align: center;
            margin-bottom: 25px;
            color: #2e7d32;
            font-weight: 800;
            font-size: 2rem;
        }

        .final-summary table {
            width: 100%; /* b·∫£ng tr·∫£i full trong wrapper */
            border-collapse: collapse;
        }

        .final-summary th, .final-summary td {
            border: 1px solid #ddd;
            padding: 60px 80px;
            text-align: center;
            font-size: 1.5rem;
        }

        .final-summary th {
            background: #a5d6a7;
            color: #1b5e20;
            font-size: 1.1rem;
        }

        .final-summary td strong {
            color: #d32f2f;
            font-weight: 700;
        }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    #star-animation-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    overflow: hidden;
    z-index: 9999;
}

/* Ng√¥i sao ch√≠nh bay l√™n */
.star-fly {
    position: fixed;
    bottom: 40px;
    left: 60px; /* g√≥c tr√°i */
    font-size: 60px;
    color: gold;
    animation: starFlyUp 2.5s ease-in-out forwards;
    text-shadow: 0 0 25px rgba(255, 215, 0, 0.9);
}

/* Ng√¥i sao nh·ªè n·ªï ra */
.star-spark {
    position: fixed;
    font-size: 16px;
    color: gold;
    opacity: 0;
    text-shadow: 0 0 15px rgba(255, 215, 0, 0.9);
    animation: sparkMove 1.5s ease-out forwards;
}

@@keyframes starFlyUp {
    0% {
        transform: translate(0, 0) scale(1);
        opacity: 1;
    }
    60% {
        transform: translate(calc(50vw - 60px), -50vh) scale(1.8);
        opacity: 1;
    }
    100% {
        transform: translate(calc(50vw - 60px), -50vh) scale(0.5);
        opacity: 0;
    }
}

/* hi·ªáu ·ª©ng n·ªï sao nh·ªè */
@@keyframes sparkMove {
    0% {
        opacity: 1;
        transform: translate(0, 0) scale(0.5);
    }
    100% {
        opacity: 0;
        transform: translate(var(--dx), var(--dy)) scale(1.4);
    }
}

</style>

<div class="contest-container">
    <!-- Welcome Section -->
    <div class="welcome-section">
        <h1 class="round-title">
            <i class="fas fa-star"></i> V√≤ng 3 - Thi ƒë·∫•u
        </h1>
        <p class="round-subtitle">
            <i class="fas fa-gift"></i> Ch·ªçn g√≥i c√¢u h·ªèi v√† s·ª≠ d·ª•ng ng√¥i sao hy v·ªçng!
        </p>
    </div>

    <!-- Package Selection -->
    <div id="package-selection" class="package-selection" style="display:none;">
        <h2 class="package-title">
            <i class="fas fa-box-open"></i> üì¶ Ch·ªçn g√≥i c√¢u h·ªèi
        </h2>
        <div class="package-buttons">
            <button id="btn40" class="package-button">
                <i class="fas fa-star"></i><br>
                G√≥i 40 ƒëi·ªÉm
            </button>
            <button id="btn60" class="package-button">
                <i class="fas fa-star"></i><i class="fas fa-star"></i><br>
                G√≥i 60 ƒëi·ªÉm
            </button>
            <button id="btn80" class="package-button">
                <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><br>
                G√≥i 80 ƒëi·ªÉm
            </button>
        </div>
        <p style="color: #666; font-style: italic;">
            <i class="fas fa-info-circle"></i> G√≥i ƒëi·ªÉm c√†ng cao, c√¢u h·ªèi c√†ng kh√≥!
        </p>
    </div>

    <!-- Question Box -->
    <div id="question-box" class="question-box" style="display:none;">
        <div class="question-header">
            <div class="question-number">
                <i class="fas fa-question-circle"></i> C√¢u <span id="question-order">--</span>
            </div>
        </div>

        <div class="question-content" id="question-content">
            <i class="fas fa-spinner loading-spinner"></i> ƒêang t·∫£i c√¢u h·ªèi...
        </div>

        <div class="answer-options">
            <button id="btnA" class="answer-button">
                <strong>A:</strong> <span id="optionA">--</span>
            </button>
            <button id="btnB" class="answer-button">
                <strong>B:</strong> <span id="optionB">--</span>
            </button>
            <button id="btnC" class="answer-button">
                <strong>C:</strong> <span id="optionC">--</span>
            </button>
            <button id="btnD" class="answer-button">
                <strong>D:</strong> <span id="optionD">--</span>
            </button>
        </div>

        <div class="star-section">
            <button id="star-button" class="star-button">
                <i class="fas fa-star"></i> D√πng ng√¥i sao hy v·ªçng ‚≠ê
            </button>
            <p style="margin: 10px 0 0 0; color: #856404; font-size: 0.9rem;">
                <i class="fas fa-lightbulb"></i> Ng√¥i sao hy v·ªçng gi√∫p b·∫°n c√≥ th√™m c∆° h·ªôi!
            </p>
        </div>

        <!-- ch·ªó hi·ªÉn th·ªã animation -->
        <div id="star-animation-container"></div>

        <div class="timer-section">
            <p class="timer-text">
                <i class="fas fa-clock"></i> Th·ªùi gian: <span id="countdown">30</span>s
            </p>
        </div>
    </div>

    <!-- Status Indicator -->
    <div class="status-indicator">
        <div class="status-text">
            <i class="fas fa-broadcast-tower"></i> Tr·∫°ng th√°i: ƒêang k·∫øt n·ªëi v·ªõi m√°y ch·ªß
        </div>
    </div>
</div>
<!-- N√∫t b·∫•m chu√¥ng -->
<div style="text-align:center;margin-top:10px;">
    <button id="btnBuzz" style="display:none;padding:10px 18px;border-radius:8px;">B·∫•m chu√¥ng</button>
</div>
<!-- K·∫øt qu·∫£ t·ªïng k·∫øt 3 v√≤ng -->
<div id="summaryBox" class="final-summary" style="display:none;"></div>

@section Scripts {
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        const socket = io("http://localhost:3000");

        const userId = "@ViewBag.UserId";
        const fullName = "@ViewBag.FullName";

        let currentQuestionId = null;
        let timerInterval = null;
        let answered = false;        // ‚úÖ ch·ªëng g·ª≠i tr√πng
        let isStarUsed = false;      // ch·ªâ ƒë·ªÉ hi·ªÉn th·ªã n√∫t, server qu·∫£n l√Ω th·∫≠t b·∫±ng v3-set-star


        // Khi c√¢u h·ªèi m·ªü cho ng∆∞·ªùi kh√°c b·∫•m chu√¥ng
        socket.on("v3-open-for-others", (data) => {
            const btn = document.getElementById("btnBuzz");
            if (!btn) return;

            // üîë ki·ªÉm tra: ch·ªâ cho ph√©p n·∫øu m√¨nh kh√¥ng ph·∫£i ng∆∞·ªùi ch·ªçn g√≥i
            if (data.ownerId === userId) {
                // m√¨nh l√† ng∆∞·ªùi ch·ªçn g√≥i => kh√¥ng cho hi·ªán n√∫t
                btn.style.display = 'none';
                btn.disabled = true;
            } else {
                // m√¨nh kh√¥ng ph·∫£i ng∆∞·ªùi ch·ªçn g√≥i => ƒë∆∞·ª£c b·∫•m chu√¥ng
                btn.style.display = 'inline-block';
                btn.disabled = false;
            }
        });

        // Khi b·∫•m chu√¥ng
        document.getElementById("btnBuzz").addEventListener("click", () => {
            socket.emit("v3-buzz", { userId });
            document.getElementById("btnBuzz").disabled = true;
        });

        // Khi admin x√°c nh·∫≠n ai ƒë∆∞·ª£c tr·∫£ l·ªùi
        socket.on("v3-buzzer-confirmed", (data) => {
            if (data.userId === userId) {
                alert("B·∫°n ƒë√£ ƒë∆∞·ª£c quy·ªÅn tr·∫£ l·ªùi!");
                document.getElementById("question-box").style.display = "block";
            } else {
                alert(`${data.fullName} ƒë√£ ƒë∆∞·ª£c quy·ªÅn tr·∫£ l·ªùi.`);
            }
            const btn = document.getElementById("btnBuzz");
            if (btn) btn.style.display = 'none';
        });
        // 2. Hi·ªÉn th·ªã c√¢u h·ªèi
        socket.on("v3-show-question", (data) => {
            currentQuestionId = data.QuestionId;
            answered = false;
            isStarUsed = data.starUsed;

            // N·∫øu th√≠ sinh ƒë√£ d√πng sao th√¨ disable n√∫t lu√¥n
            const btn = document.getElementById("star-button");
            if (isStarUsed) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-star"></i> ƒê√£ d√πng ng√¥i sao ‚≠ê';
            } else {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-star"></i> D√πng ng√¥i sao hy v·ªçng ‚≠ê';
            }

            document.getElementById("question-order").innerText = data.Order;
            document.getElementById("question-content").innerHTML =
                `<i class="fas fa-question-circle"></i> ${data.Content}`;
            document.getElementById("optionA").innerText = data.OptionA;
            document.getElementById("optionB").innerText = data.OptionB;
            document.getElementById("optionC").innerText = data.OptionC;
            document.getElementById("optionD").innerText = data.OptionD;

            enableButtons();
            startTimer();
            updateStatus(`ƒê√£ nh·∫≠n c√¢u h·ªèi ${data.Order}`);
        });


        function updateStatus(message) {
            document.querySelector('.status-text').innerHTML =
                `<i class="fas fa-broadcast-tower"></i> ${message}`;
        }

        // ‚úÖ Join ƒë√∫ng event server + gi·ªØ l·∫°i join-room (compat n·∫øu b·∫°n c√≥ handler c≈©)
        socket.emit("join-room", userId, fullName);
        socket.emit("v3-join", { userId, fullName });

        // ‚úÖ Khi admin ph√°t s·ª± ki·ªán b·∫Øt ƒë·∫ßu v√≤ng 3 -> m·ªü ch·ªçn g√≥i
        socket.on("v3-start-round", (data) => {
            if (data.userId !== userId) return; // Kh√¥ng ph·∫£i m√¨nh th√¨ b·ªè qua

            document.getElementById("package-selection").style.display = "block";
            updateStatus("V√≤ng 3 ƒë√£ b·∫Øt ƒë·∫ßu, h√£y ch·ªçn g√≥i c√¢u h·ªèi!");
        });

        // ===== Ch·ªçn g√≥i =====
        function selectPackage(points) {
            socket.emit("v3-select-package", { userId, fullName, points });
            document.getElementById("package-selection").style.display = "none";
            document.getElementById("question-box").style.display = "block";
            updateStatus(`ƒê√£ ch·ªçn g√≥i ${points} ƒëi·ªÉm`);
        }
        document.getElementById("btn40").addEventListener("click", () => selectPackage(40));
        document.getElementById("btn60").addEventListener("click", () => selectPackage(60));
        document.getElementById("btn80").addEventListener("click", () => selectPackage(80));

        // ===== Nh·∫≠n c√¢u h·ªèi =====
        socket.on("v3-show-question", (data) => {
            currentQuestionId = data.QuestionId;
            answered = false;
            isStarUsed = data.starUsed;

            document.getElementById("question-order").innerText = data.Order;
            document.getElementById("question-content").innerHTML =
                `<i class="fas fa-question-circle"></i> ${data.Content}`;
            document.getElementById("optionA").innerText = data.OptionA;
            document.getElementById("optionB").innerText = data.OptionB;
            document.getElementById("optionC").innerText = data.OptionC;
            document.getElementById("optionD").innerText = data.OptionD;

            enableButtons();

            // ‚≠ê Ch·ªâ b·∫≠t n√∫t Ng√¥i sao Hy v·ªçng n·∫øu l√† c√¢u cu·ªëi (th∆∞·ªùng l√† c√¢u 3)
            const btn = document.getElementById("star-button");
            if (isStarUsed) {
                btn.disabled = true;
                document.getElementById("star-button").style.display = "none";
                
                
                //btn.innerHTML = '<i class="fas fa-star"></i> ƒê√£ d√πng ng√¥i sao ‚≠ê';
            } else {
                if (data.Order === 3) {   // ‚úÖ ch·ªâ cho ch·ªçn ·ªü c√¢u cu·ªëi
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-star"></i> D√πng ng√¥i sao hy v·ªçng ‚≠ê';
                } else {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-star"></i> D√πng ng√¥i sao hy v·ªçng ‚≠ê';
                }
            }

            startTimer();
            updateStatus(`ƒê√£ nh·∫≠n c√¢u h·ªèi ${data.Order}`);
        });

        // ===== G·ª≠i ƒë√°p √°n (ƒë√É s·ª≠a t√™n field th√†nh 'answer' v√† d·ª´ng timer) =====
        function submitAnswer(ans) {
            if (answered) return;               // ‚úÖ ch·∫∑n double-submit
            answered = true;
            clearInterval(timerInterval);       // ‚úÖ d·ª´ng ƒë·ªìng h·ªì khi ƒë√£ g·ª≠i
            disableButtons();

            socket.emit("v3-submit-answer", {
                userId,
                questionId: currentQuestionId,
                answer: ans                      // ‚úÖ ƒê√öNG field server mong ƒë·ª£i
            });

            document.getElementById("star-button").disabled = true;
            updateStatus(`ƒê√£ g·ª≠i ƒë√°p √°n: ${ans || 'Kh√¥ng ch·ªçn'}`);
        }
        document.getElementById("btnA").addEventListener("click", () => submitAnswer("A"));
        document.getElementById("btnB").addEventListener("click", () => submitAnswer("B"));
        document.getElementById("btnC").addEventListener("click", () => submitAnswer("C"));
        document.getElementById("btnD").addEventListener("click", () => submitAnswer("D"));

        // ng√¥i sao hy v·ªçng
        document.getElementById("star-button").addEventListener("click", () => {
            
            if (isStarUsed) return;

            isStarUsed = true;
            const btn = document.getElementById("star-button");
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-star"></i> ƒê√£ d√πng ng√¥i sao ‚≠ê';

            // g·ª≠i event l√™n server
            socket.emit("v3-set-star", { userId });
            updateStatus("ƒê√£ s·ª≠ d·ª•ng ng√¥i sao hy v·ªçng");

            
                playStarAnimation();
            

        });


        function disableButtons() {
            ["btnA", "btnB", "btnC", "btnD"].forEach(id => {
                document.getElementById(id).disabled = true;
            });
        }
        function enableButtons() {
            ["btnA", "btnB", "btnC", "btnD"].forEach(id => {
                document.getElementById(id).disabled = false;
            });
            document.getElementById("star-button").disabled = false;
            document.getElementById("star-button").innerHTML =
                '<i class="fas fa-star"></i> D√πng ng√¥i sao hy v·ªçng ‚≠ê';
        }

        // ===== ƒê·ªìng h·ªì ƒë·∫øm ng∆∞·ª£c (kh√¥ng g·ª≠i tr√πng khi ƒë√£ n·ªôp) =====
        function startTimer() {
            clearInterval(timerInterval);
            let time = 30;
            document.getElementById("countdown").innerText = time;

            timerInterval = setInterval(() => {
                time--;
                document.getElementById("countdown").innerText = time;

                if (time <= 5) {
                    document.querySelector('.timer-section').style.background =
                        'linear-gradient(135deg, #ff4444 0%, #cc0000 100%)';
                }

                if (time <= 0) {
                    clearInterval(timerInterval);
                    if (!answered) {                    // ‚úÖ kh√¥ng g·ª≠i n·∫øu ƒë√£ b·∫•m
                        answered = true;
                        disableButtons();
                        socket.emit("v3-submit-answer", {
                            userId,
                            questionId: currentQuestionId,
                            answer: null                 // ‚úÖ field ƒë√∫ng t√™n
                        });
                        updateStatus("H·∫øt th·ªùi gian - T·ª± ƒë·ªông g·ª≠i ƒë√°p √°n");
                    }
                }
            }, 1000);
        }
        // b·∫£ng t·ªïng k·∫øt 3 v√≤ng
        socket.on("final-summary-results", (data) => {
            // ·∫®n to√†n b·ªô ph·∫ßn thi c≈©
            document.querySelectorAll(".contest-container, .welcome-section, .package-selection, .question-box, .status-indicator, #btnBuzz")
                .forEach(el => el.style.display = "none");

            // Hi·ªán ph·∫ßn t·ªïng k·∫øt
            const summaryDiv = document.getElementById("summaryBox");
            summaryDiv.style.display = "flex";

            let html = `
            <div>
                <h2>üèÅ K·∫øt qu·∫£ t·ªïng h·ª£p 3 v√≤ng</h2>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>H·∫°ng</th>
                            <th>T√™n th√≠ sinh</th>
                            <th>V√≤ng 1</th>
                            <th>V√≤ng 2</th>
                            <th>V√≤ng 3</th>
                            <th>T·ªïng</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

            data.sort((a, b) => b.totalScore - a.totalScore);
            data.forEach((u, i) => {
                let rankIcon = i + 1;
                if (i === 0) rankIcon = "üèÜ";
                else if (i === 1) rankIcon = "ü•à";
                else if (i === 2) rankIcon = "ü•â";

                html += `
                <tr>
                    <td>${rankIcon}</td>
                    <td>${u.fullName}</td>
                    <td>${u.v1Score}</td>
                    <td>${u.v2Score}</td>
                    <td>${u.v3Score}</td>
                    <td><strong>${u.totalScore}</strong></td>
                </tr>
            `;
            });

            html += `</tbody></table></div>`;
            summaryDiv.innerHTML = html;
        });


        // ‚≠ê Hi·ªáu ·ª©ng ng√¥i sao hy v·ªçng
        function playStarAnimation() {
            const container = document.getElementById("star-animation-container");
            if (!container) return;

            // Ng√¥i sao ch√≠nh
            const mainStar = document.createElement("div");
            mainStar.className = "star-fly";
            mainStar.innerHTML = "‚≠ê";
            container.appendChild(mainStar);

            // Khi bay xong -> t·∫°o v·ª• n·ªï sao nh·ªè
            mainStar.addEventListener("animationend", () => {
                mainStar.remove();

                // T·∫°o v·ª• n·ªï 15 ng√¥i sao nh·ªè
                for (let i = 0; i < 15; i++) {
                    const spark = document.createElement("div");
                    spark.className = "star-spark";
                    spark.innerHTML = "‚ú¶";

                    // g√≥c ng·∫´u nhi√™n xung quanh trung t√¢m
                    const angle = (Math.PI * 2 * i) / 15;
                    const radius = 150 + Math.random() * 70;
                    spark.style.setProperty("--dx", `${Math.cos(angle) * radius}px`);
                    spark.style.setProperty("--dy", `${Math.sin(angle) * radius}px`);

                    spark.style.left = "50vw";
                    spark.style.top = "40vh";
                    container.appendChild(spark);

                    // x√≥a sau khi n·ªï xong
                    spark.addEventListener("animationend", () => spark.remove());
                }
            });
        }


        // ===== Tr·∫°ng th√°i k·∫øt n·ªëi =====
        socket.on('connect', () => updateStatus('ƒê√£ k·∫øt n·ªëi v·ªõi m√°y ch·ªß'));
        socket.on('disconnect', () => updateStatus('M·∫•t k·∫øt n·ªëi v·ªõi m√°y ch·ªß'));
    </script>
}

